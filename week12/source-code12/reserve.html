<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study Plan Declaration</title>

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="reserve.css" />

    <!-- Keycloak JS -->
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@21.1.1/dist/keycloak.min.js"></script>
  </head>

  <body>
    <nav>
      <div class="logo">
        <img src="./image/SIT-LOGO-White.png" alt="SIT Logo" />
      </div>
      <ul>
        <li><h2>Study Plan Declaration</h2></li>
        <li><div class="ecors-fullname"></div></li>
        <li><button class="ecors-button-signout">Sign Out</button></li>
      </ul>
    </nav>

    <main>
      <div class="status">
        <p>
          Declaration Status: <span id="ecors-declared-plan">Not Declare</span>
        </p>
      </div>

      <div class="declare-box" id="declare-box">
        <h3>Declare Your Major</h3>

        <label for="ecors-dropdown-plan">Select Major</label>
        <select id="ecors-dropdown-plan">
          <option value="">-- Select Major --</option>
        </select>

        <button id="ecors-button-declare" disabled>Declare</button>
      </div>
    </main>

    <!-- MODAL -->
    <div id="ecors-modal" class="ecors-modal-overlay" style="display: none">
      <div class="ecors-modal-box">
        <p id="ecors-modal-message"></p>
        <button id="ecors-modal-ok" class="ecors-modal-btn">OK</button>
      </div>
    </div>

    <footer>
      <p>Â© 2025 School of Information Technology, KMUTT</p>
    </footer>

    <script>
      const isLocal = ["localhost", "127.0.0.1"].includes(
        window.location.hostname
      );

      const API_BASE = isLocal
        ? "http://localhost:3000/api/v1"
        : "http://bscit.sit.kmutt.ac.th/intproj25/kp2/itb-ecors/api";

      const KC = isLocal
        ? {
            url: "http://localhost:8180",
            realm: "itb-ecors",
            clientId: "itb-ecors-kp2",
          }
        : {
            url: "https://bscit.sit.kmutt.ac.th/intproj25/ft/keycloak/",
            realm: "itb-ecors",
            clientId: "itb-ecors-kp2",
          };

      let keycloak;

      function showDialog(msg, onOk) {
        const modal = document.getElementById("ecors-modal");
        const okBtn = document.getElementById("ecors-modal-ok");
        const msgEl = document.getElementById("ecors-modal-message");

        msgEl.textContent = msg;
        modal.style.display = "flex";

        okBtn.onclick = () => {
          modal.style.display = "none";
          if (typeof onOk === "function") {
            onOk();
          }
        };
      }

      async function initPage() {
        const token = sessionStorage.getItem("kcToken");
        const refresh = sessionStorage.getItem("kcRefreshToken");

        if (!token || !refresh) {
          return (window.location.href = "./keycloak.html");
        }

        keycloak = new Keycloak(KC);

        await keycloak.init({
          token,
          refreshToken: refresh,
          checkLoginIframe: false,
        });

        const name =
          keycloak.tokenParsed.name || keycloak.tokenParsed.preferred_username;
        document.querySelector(".ecors-fullname").textContent = name;

        const studentId = keycloak.tokenParsed.preferred_username;

        loadPlanList();
        loadDeclaredPlan(studentId);

        document.querySelector(".ecors-button-signout").onclick = () => {
          sessionStorage.clear();
          keycloak.logout({
            redirectUri: isLocal
              ? "http://127.0.0.1:5501/frontend/index.html"
              : "http://bscit.sit.kmutt.ac.th/intproj25/kp2/itb-ecors/index.html",
          });
        };

        setInterval(() => {
          keycloak.updateToken(60).then((refreshed) => {
            if (refreshed) {
              sessionStorage.setItem("kcToken", keycloak.token);
              sessionStorage.setItem("kcRefreshToken", keycloak.refreshToken);
            }
          });
        }, 60000);
      }

      function loadPlanList() {
        const dropdown = document.getElementById("ecors-dropdown-plan");
        dropdown.innerHTML = `<option value="">-- Select Major --</option>`;

        const plans = [
          { id: 1, code: "FE", name: "Frontend Developer" },
          { id: 2, code: "BE", name: "Backend Developer" },
          { id: 3, code: "FS", name: "Full-Stack Developer" },
          { id: 4, code: "AI", name: "AI Developer" },
          { id: 5, code: "DS", name: "Data Scientist" },
          { id: 6, code: "DA", name: "Data Analyst" },
          { id: 7, code: "DE", name: "Data Engineer" },
          { id: 8, code: "DB", name: "Database Admin" },
          { id: 9, code: "UX", name: "UX/UI Designer" },
        ];

        plans.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = `${p.code} - ${p.name}`;
          dropdown.appendChild(opt);
        });

        dropdown.onchange = () => {
          const btn = document.getElementById("ecors-button-declare");
          btn.disabled = dropdown.value === "";
          btn.classList.toggle("active", dropdown.value !== "");
        };
      }

      async function loadDeclaredPlan(studentId) {
        const target = document.getElementById("ecors-declared-plan");

        try {
          const res = await fetch(
            `${API_BASE}/students/${studentId}/declared-plan`
          );

          if (res.status === 404) {
            target.textContent = "Not Declared";
            return;
          }

          const data = await res.json();
          const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          const localTime = new Date(data.updatedAt).toLocaleString([], {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });

          target.textContent = `Declared ${data.studyPlan.planCode} - ${data.studyPlan.nameEng} on ${localTime} (${timezone}) `;
        } catch (err) {
          console.error(err);
          target.textContent = "Not Declared";
        }
      }

      document.getElementById("ecors-button-declare").onclick = async () => {
        const dropdown = document.getElementById("ecors-dropdown-plan");
        const planId = Number(dropdown.value);
        const studentId = keycloak.tokenParsed.preferred_username;

        try {
          const res = await fetch(
            `${API_BASE}/students/${studentId}/declared-plan`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ planId }),
            }
          );

          if (res.status === 201) {
            showDialog("Study plan declared successfully!", () => {
              document.getElementById("declare-box").style.display = "none";
              loadDeclaredPlan(studentId);
            });
            return;
          }

          if (res.status === 409) {
            showDialog(
              "You may have declared study plan already. Please check again.",
              () => {
                document.getElementById("declare-box").style.display = "none";
              }
            );

            return;
          }

          showDialog("There is a problem. Please try again later.");
        } catch (err) {
          console.error(err);
          showDialog("There is a problem. Please try again later.");
        }
      };

      initPage();
    </script>
  </body>
</html>