
สรุปสิ่งที่ได้เรียนรู้ในสัปดาห์ที่ 15 

    ระบบ Study Plan Declaration เริ่มต้นจากการตรวจสอบสภาพแวดล้อมของเว็บไซต์ว่าผู้ใช้กำลังเปิดระบบจากเครื่องตัวเอง (Local Environment) 
    หรือจากระบบจริงของมหาวิทยาลัย (Production Environment) โดยใช้ข้อมูล hostname ของหน้าเว็บ ถ้าพบว่าเป็น localhost หรือ 127.0.0.1 
    จะถือว่าเป็น Local และระบบจะผูก API URL และ Keycloak URL ให้ชี้ไปยัง server ที่ใช้ทดสอบ แต่ถ้าเป็นชื่อ domain จริงของมหาวิทยาลัย 
    ระบบจะเลือกใช้ API และ Keycloak ที่อยู่บน server จริงโดยอัตโนมัติ เพื่อให้การเชื่อมต่อและการยืนยันตัวตนถูกต้องตามสภาพแวดล้อมหลังจากนั้น 
    ระบบจะกำหนด API base URL ตามสภาพแวดล้อมดังกล่าว เพื่อใช้เรียกข้อมูลต่าง ๆ เช่น ข้อมูล declared plan ของนักศึกษา และเตรียม object 
    สำหรับตั้งค่า Keycloak ซึ่งประกอบด้วย URL ของ Keycloak, realm ของระบบ, และ clientId เพื่อให้เว็บสามารถทำงานร่วมกับระบบยืนยันตัวตน
    ได้อย่างถูกต้อง เมื่อหน้าเว็บถูกโหลด ระบบจะเริ่มทำงานที่ฟังก์ชัน initPage() เพื่อตรวจสอบว่าใน sessionStorage มี token ที่ได้มาจากการ login 
    ผ่าน Keycloak หรือไม่ หากไม่พบ token เลย ระบบจะ redirect ผู้ใช้ไปยังหน้า login ของ Keycloak ทันที หลังจากตรวจสอบ token ผ่านเรียบร้อย 
    หน้าเว็บจะสร้าง Keycloak instance ขึ้นมาแล้วพยายามทำการ init ด้วย token ที่มีอยู่ พร้อมทั้งดึงข้อมูลผู้ใช้ เช่น username เพื่อนำมาแสดงบนหน้าเว็บ
    ว่าใครเป็นคนที่กำลังใช้งานอยู่ ระบบจะเริ่มโหลดข้อมูล dropdown ของแผนการเรียน (Major/Plan) โดยใช้ข้อมูลที่กำหนดไว้ล่วงหน้าใน planMap เช่น ชื่อแผน 
    "Frontend Developer" หรือ "Fullstack Developer" และนำไปสร้างเป็นตัวเลือกใน <select> เพื่อให้ผู้ใช้เลือกแผนที่ต้องการ จากนั้นระบบจะเรียกฟังก์ชัน 
    loadDeclaredPlan(studentId) เพื่อดึงแผนที่ผู้ใช้เคยประกาศไว้จาก backend และตรวจสอบสถานะว่าเป็น declared, not declared, หรือ cancelled
    ถ้านักศึกษายังไม่เคยประกาศแผนมาก่อน ระบบจะให้ dropdown เปิดใช้งานและเปิดปุ่ม Declare ให้กดได้ แต่ถ้านักศึกษามี declared plan อยู่แล้ว ระบบจะซ่อนปุ่ม 
    Declare และแทนที่ด้วยปุ่ม Change และ Cancel แทน รวมถึงล็อก dropdown เพื่อไม่ให้แก้ไขทันทีจนกว่าจะกดปุ่ม Change ก่อน เมื่อข้อมูลประกาศของนักศึกษา
    ถูกโหลดมาจะมีการแปลงค่าเวลาที่ประกาศหรือเปลี่ยนแปลง เพื่อแสดงเป็นเวลาในเครื่องของผู้ใช้ (local time) ทำให้เข้าใจได้ง่ายขึ้นว่าประกาศหรืออัปเดตเมื่อใด
    เมื่อผู้ใช้ต้องการเปลี่ยนแผนการเรียน ระบบจะเปิด dropdown ให้เลือกแผนใหม่ และเมื่อกดปุ่ม Change ระบบจะตรวจสอบว่าแผนที่เลือกใหม่ไม่ซ้ำกับแผนเดิม 
    จากนั้นจะส่งคำขอแบบ PUT ไปยัง backend เพื่อบันทึกการแก้ไขแผน พร้อมแจ้งผลลัพธ์แบบ popup โดยใช้ showDialog() หากสำเร็จจะแจ้งว่าทำการเปลี่ยนแปลง
    เรียบร้อย สำหรับการยกเลิกแผนการเรียน ปุ่ม Cancel จะเปิด dialog แบบยืนยัน โดยให้ข้อมูลแผนที่กำลังจะยกเลิก ชื่อแผน และเวลาที่ประกาศ เพื่อให้ผู้ใช้ตรวจสอบ
    ก่อน ระบบใช้กล่องยืนยันแบบ custom ที่เขียนเองเพื่อให้สามารถใส่เนื้อหาและปุ่มที่ต้องการได้ เมื่อผู้ใช้กดยืนยัน ระบบจะส่งคำขอ DELETE ไปยัง backend เพื่อบันทึก
    สถานะการยกเลิก และหลังจากทำงานเสร็จ จะเปลี่ยนหน้าเว็บให้แสดงข้อความว่าผู้ใช้ได้ยกเลิกแผนไปแล้ว พร้อมล็อก dropdown และปุ่มต่าง ๆ ไม่ให้แก้ไขจนกว่าจะประกาศใหม่
    นอกจากนี้ ระบบยังมีการตั้งค่าให้ refresh token ใหม่ทุก ๆ 60 วินาที เพื่อให้ session ของผู้ใช้ยังคงอยู่และไม่หลุดออกจากระบบโดยไม่ตั้งใจ รวมถึงจัดการเหตุการณ์
    ต่าง ๆ เช่น การ signout ที่จะล้าง sessionStorage และส่งผู้ใช้กลับไปหน้า login อีกครั้ง

--------------------------------------------------------------------------------------------------------------------------------------------
น.ส.ธันวาวีร์ นิธิพรชัยวงศ์ รหัสนักศึกษา:67130500131